#{extends './_application.html' /}
#{set title:'Home' /}

#{set 'moreHead'}
<script type="text/javascript">
    function rgbToHex(r, g, b) {
        return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
    }

    $(function() {
        $.attrHooks['preserveAspectRatio'] = {
            set: function(elem, value, name) {
                elem.setAttributeNS(null, 'preserveAspectRatio', value + '');
                return value;
            }
        };
        $.attrHooks['viewbox'] = {
            set: function(elem, value, name) {
                elem.setAttributeNS(null, 'viewBox', value + '');
                return value;
            }
        };

        $(window).resize(function() {
            $("iframe[src^='//www.youtube.com']").each(function() {
                var $el = $(this);
                var newWidth = $(this).parent().width();
                $el.width(newWidth).height(newWidth * 800 / 1280);
            });
        }).resize();

        var arrayClanWarSummary = [
            { nth: 36, date: "2015-05-05", starsGain: 24, starsLost: 21, urlJson: '', enemyClanName: 'cujos', enemyClanTag:'#' },
            { nth: 35, date: "2015-05-03", starsGain: 24, starsLost: 19, urlJson: '', enemyClanName: 'Mogan', enemyClanTag:'#' },
            { nth: 34, date: "2015-04-28", starsGain: 25, starsLost: 21, urlJson: '', enemyClanName: 'Banana Boat', enemyClanTag:'#' },
            { nth: 33, date: "2015-04-22", starsGain: 23, starsLost: 26, urlJson: '', enemyClanName: 'Active Ternopil', enemyClanTag:'#' },
            { nth: 32, date: "2015-04-19", starsGain: 30, starsLost: 26, urlJson: '', enemyClanName: 'ＤＩＡＢＬＥ', enemyClanTag:'#' },
            { nth: 31, date: "2015-04-17", starsGain: 50, starsLost: 38, urlJson: '', enemyClanName: 'MdNt Assassinz', enemyClanTag:'#' },
            { nth: 30, date: "2015-04-15", starsGain: 44, starsLost: 46, urlJson: '', enemyClanName: 'C.O.C. Lovers', enemyClanTag:'#' },
            { nth: 29, date: "2015-04-12", starsGain: 24, starsLost: 17, urlJson: '', enemyClanName: '5TH CITY', enemyClanTag:'#' },
            { nth: 28, date: "2015-04-09", starsGain: 28, starsLost:  2, urlJson: '', enemyClanName: 'Team Swole', enemyClanTag:'#' },
            { nth: 27, date: "2015-04-05", starsGain: 51, starsLost: 69, urlJson: '', enemyClanName: '宮方一区', enemyClanTag:'#' },
            { nth: 26, date: "2015-03-25", starsGain: 56, starsLost: 66, urlJson: '', enemyClanName: 'みんな友達', enemyClanTag:'#' },
            { nth: 25, date: "2015-03-15", starsGain: 60, starsLost: 57, urlJson: '/public/warEvents/warEvents.25.20150315.json', enemyClanName: '傲视@群雄', enemyClanTag:'#2PLY22CV' },
            { nth: 24, date: "2015-03-05", starsGain: 59, starsLost: 57, urlJson: '', enemyClanName: 'THE DARK LEGION', enemyClanTag:'#' },
            { nth: 23, date: "2015-02-25", starsGain: 57, starsLost: 53, urlJson: '', enemyClanName: 'TOP SZN', enemyClanTag:'#' },
            { nth: 22, date: "2015-02-15", starsGain: 59, starsLost: 46, urlJson: '', enemyClanName: 'FAM BAM', enemyClanTag:'#' },
            { nth: 21, date: "2015-02-05", starsGain: 27, starsLost: 67, urlJson: '', enemyClanName: 'INDO BEST CLAN', enemyClanTag:'#' },
            { nth: 20, date: "2015-01-25", starsGain: 61, starsLost: 54, urlJson: '', enemyClanName: 'YOUR BAD DREAM', enemyClanTag:'#' },
            { nth: 19, date: "2015-01-15", starsGain: 59, starsLost: 69, urlJson: '', enemyClanName: 'TamBun HeBat', enemyClanTag:'#' },
            { nth: 18, date: "2015-01-05", starsGain: 66, starsLost: 64, urlJson: '/public/warEvents/warEvents.18.20150105.json', enemyClanName: 'Bakesi COC\' ers', enemyClanTag:'#2PV89QCG' },
            { nth: 17, date: "2014-12-25", starsGain: 69, starsLost: 66, urlJson: '/public/warEvents/warEvents.17.20141225.json', enemyClanName: 'borneo clan', enemyClanTag:'#8GLRVUVY' },
            { nth: 16, date: "2014-12-15", starsGain: 64, starsLost: 27, urlJson: '/public/warEvents/warEvents.16.20141215.json', enemyClanName: 'Bali Paradise', enemyClanTag:'#2G88GQCG' },
            { nth: 15, date: "2014-12-05", starsGain: 72, starsLost: 64, urlJson: '/public/warEvents/warEvents.15.20141205.json', enemyClanName: 'Pinoy DEA', enemyClanTag:'#2YYGP09QP' },
            { nth: 14, date: "2014-11-25", starsGain: 68, starsLost: 67, urlJson: '/public/warEvents/warEvents.14.20141125.json', enemyClanName: 'PASIG ELITE', enemyClanTag:'#9Y0YP09L' },
            { nth: 13, date: "2014-11-16", starsGain: 50, starsLost: 34, urlJson: '/public/warEvents/warEvents.13.20141116.json', enemyClanName: 'Big Dawgz' },
            { nth: 12, date: "2014-11-05", starsGain: 60, starsLost:  4, urlJson: '/public/warEvents/warEvents.12.20141105.json', enemyClanName: 'Chronicle' },
            { nth: 11, date: "2014-10-20", starsGain: 64, starsLost: 59, urlJson: '', enemyClanName: "iran sky" },
            { nth: 10, date: "2014-10-13", starsGain: 65, starsLost: 64, urlJson: '', enemyClanName: "Natsoe Empire" },
            { nth:  9, date: "2014-10-06", starsGain: 62, starsLost: 64, urlJson: '', enemyClanName: "沙漠之狐" },
            { nth:  8, date: "2014-09-29", starsGain: 72, starsLost: 26, urlJson: '', enemyClanName: "ZHUMABAI CLANS" },
            { nth:  7, date: "2014-09-22", starsGain: 70, starsLost: 07, urlJson: '', enemyClanName: "Winston Rules" },
            { nth:  6, date: "2014-09-15", starsGain: 55, starsLost: 25, urlJson: '', enemyClanName: "T1rd Burglers" },
            { nth:  5, date: "2014-09-08", starsGain: 41, starsLost: 15, urlJson: '', enemyClanName: "SuperNova" },
            { nth:  4, date: "2014-09-01", starsGain: 25, starsLost: 12, urlJson: '', enemyClanName: "湖里JW" },
            { nth:  3, date: "2014-08-25", starsGain: 29, starsLost: 21, urlJson: '', enemyClanName: "clan Tu Do" },
            { nth:  2, date: "2014-08-18", starsGain: 27, starsLost: 12, urlJson: '', enemyClanName: "TURK'S TEAM" },
            { nth:  1, date: "2014-08-11", starsGain: -1, starsLost: -1, urlJson: '', enemyClanName: "???" }
        ];

        $.each(arrayClanWarSummary, function (index, value) {
            value.starsGainPercent = value.starsGain * 100 / (value.starsGain + value.starsLost);
            value.starsLostPercent = value.starsLost * 100 / (value.starsGain + value.starsLost);
            value.isVictory = value.starsGain > value.starsLost;
            value.isDefeat = value.starsGain < value.starsLost;

            var backgroundColor = "#eee";
            if (value.starsGainPercent > 50) {
//                99 -> #0e0 : 100 - 99 = 1
//                51 -> #ded : 100 - 51 = 49
                var colorBase = Math.floor((100 - value.starsGainPercent) * 100 / 50) + 110;
                backgroundColor = rgbToHex(colorBase, 240, colorBase);
            } else if (value.starsGainPercent < 50){
                var colorBase = Math.floor((value.starsGainPercent) * 100 / 50) + 110;
                backgroundColor = rgbToHex(240, colorBase, colorBase);
            }

            value.summaryBackgroundColor = backgroundColor; // value.isVictory ? "#efe" : value.isDefeat ? "#fee" : "#eee";

            $('.expandableClanWarHistory').append(ich.templateClanWarSummary(value));
        });
        $(document).on("click", ".clanWarSummary .title", function(){
            var $parent = $(this).parent();
            var $content = $(".content", $parent);
            if(!$content.html()) {
                var dataUrl = $parent.attr('data-url');
                if(!dataUrl)
                {
                    $content.html(ich.templateClanWarContentNotAvailable());
                    return;
                }

                $.get(
                        dataUrl,
                        {},
                        function (data, textStatus, jqXHR) {
                            var aaaaa = ich.templateClanWarContent(data);
                            $content.append(aaaaa);

                            height = 40;
                            var svg = createSvg('svg');
                            svg.attr({
                                width: '100%',
                                'preserveAspectRatio': "xMinYMin meet",
                                'viewBox': "0 0 800 " + (data.arrayMember.length + 1) * height
                            });


                            var dicMemberRank = {};
                            var dicEnemyRank = {};
                            for(var i = 0; i < data.arrayMember.length; i++) { dicMemberRank[data.arrayMember[i]] = i; }
                            for(var i = 0; i < data.arrayEnemy.length; i++) { dicEnemyRank[data.arrayEnemy[i]] = i }

                            $.each(data.arrayMember, function (index, value) {
                                svg.append(createSvg("text").attr({
                                    'class': 'coc name', x: 200, y: (index + 1) * height, fill: '#55f', 'text-anchor': "end"
                                }).text(value));
                                svg.append(createSvg("text").attr({
                                    'class': 'coc countMember' + index, x: 210, y: (index + 1) * height, fill: '#555', 'text-anchor': "start"
                                }).text(0));
                            });
                            $.each(data.arrayEnemy, function (index, value) {
                                svg.append(createSvg("text").attr({
                                    'class': 'coc name', x: 600, y: (index + 1) * height, fill: '#f55', 'text-anchor': "start"
                                }).text(value));
                                svg.append(createSvg("text").attr({
                                    'class': 'coc countEnemy' + index, x: 590, y: (index + 1) * height, fill: '#555', 'text-anchor': "end"
                                }).text(0));
                            });
                            if(data.arrayWarEvent) {
                                $.each(data.arrayWarEvent, function (index, value) {
                                    svg.append(createSvg("line").addClass('coc').attr({
                                        'class': 'warLine' + index,
                                        x1: 240, x2: 560,
                                        y1: dicMemberRank[value[1]] * height + 35,
                                        y2: dicEnemyRank[value[2]] * height + 35
                                    }).css({
                                        stroke: value[0] == "a" ? "#00f" : "#f00",
                                        strokeWidth: (value[4] + 1) * 2,
                                        opacity: ((value[3] + 20) / 200)
                                    }));
                                    if(value[0] == "a") {
                                        var countEnemy = svg.find('.countEnemy' + dicEnemyRank[value[2]]);
                                        countEnemy.text(parseInt(countEnemy.text()) + 1);
                                    } else {
                                        var countMember = svg.find('.countMember' + dicMemberRank[value[1]]);
                                        countMember.text(parseInt(countMember.text()) + 1);
                                    }
                                });
                            }
                            if(data.arrayWarEventRankReverse) {
                                data.arrayWarEventRankReverse.reverse();
                                $.each(data.arrayWarEventRankReverse, function (index, value) {
                                    svg.append(createSvg("line").addClass('coc').attr({
                                        'class': 'warLine' + index,
                                        x1: 240, x2: 560,
                                        y1: (value[1] - 1) * height + 35,
                                        y2: (value[2] - 1) * height + 35
                                    }).css({
                                        stroke: value[0] == "a" ? "#00f" : "#f00",
                                        strokeWidth: (value[4] + 1) * 2,
                                        opacity: ((value[3] + 20) / 200)
                                    }));
                                    if(value[0] == "a") {
                                        var countEnemy = svg.find('.countEnemy' + (value[2] - 1));
                                        countEnemy.text(parseInt(countEnemy.text()) + 1);
                                    } else {
                                        var countMember = svg.find('.countMember' + (value[1] - 1));
                                        countMember.text(parseInt(countMember.text()) + 1);
                                    }
                                });
                            }
                            $('.chartBipartite', $content).append(svg);
                            $(window).resize();
                            timer();
                        }
                ).error(function (jqXHR, textStatue, httpStatus) {
                    alert(jqXHR.responseJSON.message);
                });

            } else {
                $content.html('');
            }
            return false;
        });

        $('.buildOrder a').attr('target', '_blank');

        $(".clanWarSummary .title").first().click();
        setInterval(timer, 1000);

    });

    var until = 0;
    function timer() {
        until++;
        if(until > 100)
            until = 0;

        for (var i = 0; i < 200; i++) {
            if (i < until) {
                $(".warLine" + i).show();
            }
            else {
                $(".warLine" + i).hide();
            }
        }
    }

    function createSvg(name) {
        return $(document.createElementNS("http://www.w3.org/2000/svg", name));
    }
</script>
<script type="text/html" id="templateClanWarSummary">
    <div class="clanWarSummary" data-url="{{urlJson}}">
        <div class="title" style="background: {{summaryBackgroundColor}}; border: 1px solid #ccc; padding: 10px; cursor: pointer;">
            <span class="coc">{{enemyClanName}}</span> - {{nth}}차전 {{date}}
            <div class="progress" style="margin-bottom: 0px;">
                <div class="coc progress-bar progress-bar-striped" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: {{starsGainPercent}}%">
                    {{starsGain}}
                </div>
                <div class="coc progress-bar progress-bar-danger progress-bar-striped" style="width: {{starsLostPercent}}%">
                    {{starsLost}}
                </div>
            </div>

        </div>
        <div class="content" data-url="{{dataJson}}" ></div>
    </div>
</script>
<script type="text/html" id="templateClanWarContent">
    <div style="background: #fff; border: 1px solid #ccc; padding: 20px;">
        <h4 class="coc" style="text-align: center;">Summary</h4>
        <div style="text-align: center">
            {{summary}}
        </div>
        <h4 class="coc" style="text-align: center;">War Events</h4>
        <p style="text-align: center;">
            파란색은 공격, 붉은색은 방어, 굵기는 별 획득수, 투명도는 파괴율입니다.
        </p>
        <p style="text-align: center;">
            닉네임 옆의 숫자는 공격받은 횟수입니다.
        </p>
        <div class="chartBipartite"></div>
        <div class="row">
            {{#mostHeroicAttack}}
                <div class="col-md-12">
                    <h4 class="coc" style="text-align: center;">Most Heroic Attack</h4>
                    <h5 class="coc" style="text-align: center;">{{mostHeroicAttack.title}}</h5>
                    <iframe width="1280" height="800" src="{{mostHeroicAttack.url}}" frameborder="0" allowfullscreen></iframe>
                </div>
            {{/mostHeroicAttack}}
            {{#mostHeroicDefense}}
                <div class="col-md-12">
                    <h4 class="coc" style="text-align: center;">Most Heroic Defense</h4>
                    <h5 class="coc" style="text-align: center;">{{mostHeroicDefense.title}}</h5>
                    <iframe width="1280" height="800" src="{{mostHeroicDefense.url}}" frameborder="0" allowfullscreen></iframe>
                </div>
            {{/mostHeroicDefense}}
        </div>
        {{#arrayFeaturedBattle.length}}
        <div class="row">
            <div style="height: 50px;"> </div>
            <h4 class="coc" style="text-align: center;">Featured Battles</h4>
            {{#arrayFeaturedBattle}}
            <div class="col-md-6">
                <h5 class="coc" style="text-align: center;">{{title}}</h5>
                <iframe width="1280" height="800" src="{{url}}" frameborder="0" allowfullscreen></iframe>
            </div>
            {{/arrayFeaturedBattle}}
        </div>
        {{/arrayFeaturedBattle.length}}
    </div>
</script>
<script type="text/html" id="templateClanWarContentNotAvailable">
    <div style="background: #fff; border: 1px solid #ccc; padding: 20px;">
        Details not available.
    </div>
</script>
<script type="text/html">
    <div class="col-md-6">
        <h5 style="text-align: center;">Kang Ill Goo vs tgrubb5</h5>
        <iframe width="1280" height="800" src="//www.youtube.com/embed/ssnwso4R7nc" frameborder="0" allowfullscreen></iframe>
    </div>
</script>
#{/set}

<div class="container" style="padding: 10px;">
    <h3 class="coc">Facebook Group</h3>
    <ul>
        <li><a href="https://www.facebook.com/groups/wururung">http://facebook.com/groups/wururung</a></li>
    </ul>

    <h3 class="coc">Rules</h3>
    <ul>
        <li><s>매달 5일, 15일, 25일 14시에 클랜전을 시작합니다.</s> 2015-04-16부터 상시 클전 체제로 전환합니다. 클전 참여 상태가 켜져 있으면 참가표시라고 보고 무조건 클전 돌립니다. 상시 클전이 부담스러우신 분께서는 꺼두셨다가 하고 싶을때 켜시면 바로 참전됩니다.</li>
        <li>클랜전 참여인원이 되었을 경우 공격기회를 반드시 사용하여 주세요.</li>
    </ul>

    <h3 class="coc">Build Order</h3>
    <ol class="buildOrder">
        <li><a href="http://clashofclans.wikia.com/wiki/Clan_Castle">클랜성(Clan Castle)</a>을 인구수 20이 될 때까지. 20이 되어야 <a href="http://clashofclans.wikia.com/wiki/Dragon">드래곤(Dragon)</a>을 드릴 수 있습니다. 그 이상은 선택입니다.</li>
        <li>새로 생긴 건물(<a href="http://clashofclans.wikia.com/wiki/Gold_Mine">금광(Gold Mine)</a>, <a href="http://clashofclans.wikia.com/wiki/Elixir_Collector">엘릭서 정제소(Elixir Collector)</a>는 선택)</li>
        <li><a href="http://clashofclans.wikia.com/wiki/Laboratory">연구소(Laboratory)</a> 풀업</li>
        <li><a href="http://clashofclans.wikia.com/wiki/Army_Camp">집합소(Army Camp)</a> 풀업</li>
        <li><a href="http://clashofclans.wikia.com/wiki/Spell Factory">마법제작소(Spell Factory)</a> 풀업</li>
        <li><a href="http://clashofclans.wikia.com/wiki/Mortar">박격포(Mortar)</a></li>
        <li><a href="http://clashofclans.wikia.com/wiki/Wizard_Tower">마법사타워(Wizard Tower)</a></li>
        <li><a href="http://clashofclans.wikia.com/wiki/Air_Defense">대공포(Air Defense)</a></li>
        <li><a href="http://clashofclans.wikia.com/wiki/Hidden_Tesla">뇌전탑(Hidden Tesla)</a></li>
        <li><a href="http://clashofclans.wikia.com/wiki/Archer_Tower">아처타워(Archer Tower)</a></li>
        <li><a href="http://clashofclans.wikia.com/wiki/Cannon">대포(Cannon)</a></li>
        <li><a href="http://clashofclans.wikia.com/wiki/Gold_Storage">금 저장소(Gold Storage)</a>, <a href="http://clashofclans.wikia.com/wiki/Elixir_Storage">엘릭서 저장소(Elixir Storage)</a>, <a href="http://clashofclans.wikia.com/wiki/Dark_Elixir_Storage">다크 엘릭서 저장소(Gold Storage)</a>, 훈련소(Barrack), 암흑훈련소(Dark Barrack)는 필요에 따라</li>
        <li>대부분의 업그레이드(<a href="http://clashofclans.wikia.com/wiki/Wall">벽(Wall)</a>포함)를 끝낸 후 타운홀을 올려야 합니다. 타운홀 레벨 차이에 따라 공격시 자원 획득률이 달라지게 되므로 업그레이드를 완료하지 않고 먼저 올리면 자원 수급이 원활하지 않아 가난해집니다.</li>
    </ol>

    <h3 class="coc">Clan War Strategy</h3>
    내 프로필(My Profile)에서 클랜전 참여 여부를 설정하실 수 있습니다. 하지만 인원이 부족할 경우 불참으로 설정하셨어도 참여인원이 될 수 있습니다.
    <h4 class="coc">Defense</h4>
    <ul>
        <li>War Base에서 Town Hall과 Clan Castle은 가장 안전한 위치에 두세요.</li>
        <li>War Base의 방어병력은 상위 랭커가 채웁니다.</li>
        <li>새로 추가된 건물들이 있을 수 있으니 War Base를 꼭 점검해 주세요.</li>
        <li>War Base의 자원은 약탈당하더라도 본진 자원이 약탈당하는게 아니고, 아무 피해가 없습니다.</li>
    </ul>
    <h4 class="coc">Attack</h4>
    <ul>
        <li>첫 공격은 자신과 동순위의 적을 공격해야 합니다.</li>
        <li>두번째 공격은 자신의 순위 근방을 공격해 주세요. 너무 낮은 곳을 공격하면 하위 랭커가 공격할 수가 없습니다.</li>
        <li>아래에서부터 별 획득 위주로 별을 쓸어담아 올라가게 됩니다.</li>
        <li>공격 전에 Dragon을 드릴테니 필히 요청주세요. 또한 Spell이 있는지 확인해 주세요.</li>
        <li>클랜성 병력을 유인하여 처리한 후 공격합니다.</li>
        <li>드래곤은 다른 유닛과 섞는 것 보다 드래곤만 뽑아서 공격하는게 낫습니다.</li>
    </ul>

    <h3 class="coc">Clan War History</h3>

    <div class="expandableClanWarHistory">

    </div>

    <h3 class="coc">Replay</h3>
    %{
        def listReplay = [
            ["라바하운드 2", "//www.youtube.com/embed/2oYAj7tMFkQ"],
            ["그냥 폭탄도 뭉치면 강해요^^", "//www.youtube.com/embed/xQ-3Quzriok"]
        ];
    }%
    #{list 0..listReplay.size() - 1}
        <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="headingReplay${_}">
                <h4 class="panel-title">
                    <a class="collapsed" data-toggle="collapse" data-parent="#accordion" href="#collapseReplay${_}" aria-expanded="false" aria-controls="collapseReplay${_}">
                    ${listReplay[_][0]}
                    </a>
                </h4>
            </div>
            <div id="collapseReplay${_}" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingReplay${_}">
                <div class="panel-body">
                    <iframe width="1280" height="800" src="${listReplay[_][1]}" frameborder="0" allowfullscreen></iframe>
                </div>
            </div>
        </div>
    #{/list}
    <hr/>

    <hr/>
    Contact:
    <a href="http://facebook.com/aha00a">
        <img style="width: 16px; height: 16px; vertical-align: middle;" src="https://fbcdn-profile-a.akamaihd.net/hprofile-ak-xaf1/v/t1.0-1/c12.12.155.155/576889_449528545089056_951742509_n.jpg?oh=30c8be2776e4c1b051b84c63c4e118ab&oe=54EC28AE&__gda__=1425594912_c0022cd343e150b1199404c85e54fad0"/>
        Aha00a
    </a>


</div>
